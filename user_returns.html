<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <title>Âà©Áî®ËÄÖÂà•ËøîÂç¥„Ç∑„Çπ„ÉÜ„É†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
      @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap');

      /* --- General Styles --- */
      body {
        font-family: 'Noto Sans JP', sans-serif;
        background: linear-gradient(135deg, #f5f1e8 0%, #e8dfd2 100%);
        color: #2c3e50;
        margin: 0;
        padding: 0;
        line-height: 1.7;
        font-size: 48px;
        -webkit-text-size-adjust: 100%;
        min-height: 100vh;
        position: relative;
      }
      
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: 
          repeating-linear-gradient(
            45deg,
            transparent,
            transparent 35px,
            rgba(139, 111, 78, 0.03) 35px,
            rgba(139, 111, 78, 0.03) 70px
          );
        pointer-events: none;
        z-index: 1;
      }
      .container {
        position: relative;
        z-index: 2;
        margin: 0;
        padding: 45px;
        background-color: rgba(255, 255, 255, 0.95);
        width: 100%;
        min-height: 100vh;
        box-sizing: border-box;
        box-shadow: 0 0 50px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #8b6f4e;
        margin-top: 0;
        text-align: center;
        margin-bottom: 90px;
        border-bottom: 6px solid #d4af37;
        padding-bottom: 60px;
        font-size: 72px;
        font-family: 'Noto Serif JP', serif;
        font-weight: 700;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        position: relative;
      }
      
      h1::before {
        content: "üë§";
        display: block;
        font-size: 48px;
        margin-bottom: 20px;
      }
      h2 {
          margin-top: 120px;
          text-align: left;
          border-bottom: none;
          font-size: 60px;
          color: #8b6f4e;
          padding-left: 30px;
          padding-right: 30px;
          font-family: 'Noto Serif JP', serif;
          font-weight: 700;
      }

      /* --- Form Styles --- */
      .form-group {
        margin-bottom: 90px;
        background: rgba(255, 255, 255, 0.7);
        padding: 45px;
        border-radius: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      }
      label {
        display: block;
        margin-bottom: 45px;
        font-weight: 700;
        color: #8b6f4e;
        font-size: 54px;
        font-family: 'Noto Serif JP', serif;
        position: relative;
        padding-left: 60px;
      }
      
      label::before {
        content: "‚ñ∏";
        position: absolute;
        left: 0;
        color: #d4af37;
        font-size: 48px;
      }
      input[type="text"], input[type="number"] {
        width: 100%;
        padding: 45px;
        border: 3px solid #d4af37;
        border-radius: 15px;
        box-sizing: border-box;
        font-size: 48px;
        font-family: 'Noto Sans JP', sans-serif;
        -webkit-appearance: none;
        appearance: none;
        background: rgba(255, 255, 255, 0.9);
        transition: all 0.3s ease;
      }
      
      input[type="text"]:focus, input[type="number"]:focus {
        outline: none;
        border-color: #8b6f4e;
        box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.2);
      }
      input[readonly] {
        background-color: #f8f5f0;
        cursor: not-allowed;
        border-color: #ddd;
      }
      /* „Ç´„É°„É©Âàá„ÇäÊõø„Åà„Éú„Çø„É≥ */
      .camera-switch-btn {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 36px;
        border-radius: 10px;
        cursor: pointer;
        margin-right: 20px;
      }

      .camera-switch-btn:hover {
        background-color: #0056b3;
      }
      
      /* Âü∫Êú¨„Éú„Çø„É≥„Çπ„Çø„Ç§„É´ */
      button {
        color: white;
        padding: 45px 60px;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        font-size: 48px;
        font-weight: 700;
        transition: all 0.3s ease;
        margin-top: 45px;
        font-family: 'Noto Sans JP', sans-serif;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
        min-height: 132px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        background: linear-gradient(135deg, #8b6f4e 0%, #6d5640 100%);
      }
      
      button::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
        transform: scale(0);
        transition: transform 0.5s ease;
      }
      
      button:hover::before {
        transform: scale(1);
      }
      
      button:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
      }
      button:disabled {
        background: linear-gradient(135deg, #cccccc 0%, #999999 100%);
        color: #666666;
        cursor: not-allowed;
        opacity: 0.7;
        box-shadow: none;
      }
      /* „Çπ„Ç≠„É£„É≥„Éú„Çø„É≥ */
      #scan-user-id-button { 
         padding: 36px 60px;
         background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
         margin-right: 30px;
         font-size: 48px;
         font-weight: 400;
      }
      #scan-user-id-button:hover { 
         background: linear-gradient(135deg, #495057 0%, #343a40 100%);
      }
      /* Ê§úÁ¥¢„Éú„Çø„É≥ */
      button[onclick="searchUserRentals()"] {
          margin-top: 60px;
          font-weight: 700;
          padding: 45px 60px;
          font-size: 54px;
          width: 100%;
          min-height: 150px;
          background: linear-gradient(135deg, #d4af37 0%, #b8941f 100%);
          position: relative;
      }
      
      button[onclick="searchUserRentals()"]::after {
        content: "üîç";
        position: absolute;
        right: 60px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 60px;
      }
      
      button[onclick="searchUserRentals()"]:hover {
          background: linear-gradient(135deg, #b8941f 0%, #9a7a19 100%);
      }
      /* Ê§úÁ¥¢„Éú„Çø„É≥ */
      #search-user-button {
        background: linear-gradient(135deg, #4e7b8b 0%, #405d6d 100%);
      }
      #search-user-button:hover {
        background: linear-gradient(135deg, #405d6d 0%, #334a56 100%);
      }
      
      /* „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ */
      .book-checkbox {
          width: 84px; /* 3ÂÄç„Å´Êã°Â§ß */
          height: 84px; /* 3ÂÄç„Å´Êã°Â§ß */
          cursor: pointer;
      }
      
      /* „Åæ„Å®„ÇÅ„Å¶ËøîÂç¥„Éú„Çø„É≥ */
      #bulk-return-button {
          background: linear-gradient(135deg, #8b5a4e 0%, #6d4640 100%);
          padding: 45px 60px;
          font-size: 54px;
          margin-top: 75px;
          display: block;
          width: 100%;
          min-height: 150px;
          position: relative;
      }
      
      #bulk-return-button::after {
        content: "üìö";
        position: absolute;
        right: 60px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 60px;
      }
      
      #bulk-return-button:hover {
          background: linear-gradient(135deg, #6d4640 0%, #5a3a35 100%);
      }
      #bulk-return-button:disabled {
          background: linear-gradient(135deg, #cccccc 0%, #999999 100%);
          cursor: not-allowed;
      }

      /* --- Scanner Container --- */
      /* „Çπ„Ç≠„É£„Éä„Éº„Ç≥„É≥„ÉÜ„Éä */
      .scanner-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #000;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      /* „Çπ„Ç≠„É£„Éä„Éº„Éò„ÉÉ„ÉÄ„Éº */
      .scanner-header {
        position: absolute;
        top: 0;
        right: 0;
        padding: 20px;
        z-index: 1002;
      }

      .close-scanner-btn {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 36px;
        border-radius: 10px;
        cursor: pointer;
      }

      /* „Çπ„Ç≠„É£„Éä„Éº„Éì„É•„Éº„Éù„Éº„Éà */
      .scanner-viewport {
        position: relative;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background-color: #000;
      }

      /* Quagga„ÅÆË¶ÅÁ¥†„ÇíÂà∂Âæ° */
      .scanner-viewport canvas,
      .scanner-viewport video {
        position: absolute !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        width: 100% !important;
        height: 100% !important;
        max-width: none !important;
        max-height: none !important;
        object-fit: cover !important;
      }

      /* ‰∏çË¶Å„Å™Ë¶ÅÁ¥†„ÇíÂÆåÂÖ®„Å´ÂâäÈô§ */
      .scanner-viewport br,
      .scanner-viewport .drawingBuffer,
      .scanner-viewport canvas:not(:last-child) {
        display: none !important;
      }

      /* „Çπ„Éû„ÉõÂØæÂøú */
      @media (max-width: 768px) {
        .scanner-viewport {
          width: 100%;
          height: 100%;
        }
        
        .close-scanner-btn {
          font-size: 24px;
          padding: 10px 20px;
        }
      }


      /* --- Results Area --- */
      #rental-records {
        margin-top: 90px; /* 3ÂÄç„Å´Êã°Â§ß */
      }
      #records-container {
          overflow-x: auto; /* „ÉÜ„Éº„Éñ„É´„Åå„ÅØ„ÅøÂá∫„ÅôÂ†¥Âêà„Å´„Çπ„ÇØ„É≠„Éº„É´ */
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 60px; /* „ÉÜ„Éº„Éñ„É´‰∏ä„ÅÆ„Çπ„Éö„Éº„Çπ„Çí3ÂÄç„Å´Êã°Â§ß */
        font-size: 48px; /* „ÉÜ„Éº„Éñ„É´ÊñáÂ≠ó„Çµ„Ç§„Ç∫„Çí3ÂÄç„Å´Êã°Â§ß */
      }
      th, td {
        padding: 45px; /* „Çª„É´„ÅÆ„Éë„Éá„Ç£„É≥„Ç∞„Çí3ÂÄç„Å´Êã°Â§ß */
        text-align: left;
        border-bottom: 3px solid #d0d0d0; /* Á∑ö„Çí3ÂÄç„Å´Êã°Â§ß */
      }
      th {
        background-color: #f8f5f0;
        color: #8b6f4e;
        font-weight: 700;
        white-space: nowrap;
        font-family: 'Noto Serif JP', serif;
      }
      tr:nth-child(even) {
          background-color: #f8f9fa; /* ‰∫§‰∫í„Å´ËÉåÊôØËâ≤ */
      }
      tr:hover {
        background-color: #f5f1e8;
      }
      .no-records {
        font-style: italic;
        color: #666;
        text-align: center;
        padding: 75px; /* „Éë„Éá„Ç£„É≥„Ç∞„Çí3ÂÄç„Å´Êã°Â§ß */
        font-size: 3.3em; /* 3ÂÄç„Å´Êã°Â§ß */
      }

      /* --- Message Area --- */
      #message {
        margin-top: 90px;
        font-weight: 700;
        padding: 45px;
        border-radius: 20px;
        text-align: center;
        font-size: 48px;
        position: relative;
        overflow: hidden;
      }
      /* „É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÁ®ÆÈ°û„Å´Âøú„Åò„Å¶„Çπ„Çø„Ç§„É´„ÇíÂ§â„Åà„ÇãÔºà‰æãÔºâ */
      #message:not(:empty) {
         display: block;
         background: linear-gradient(135deg, #e2f3ff 0%, #d6ecff 100%);
         border: 3px solid #b8dffc;
         color: #0056b3;
         box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      /* --- Responsive Design --- */
      @media (max-width: 768px) { /* „ÉÜ„Éº„Éñ„É´„Åå„ÅÇ„Çã„ÅÆ„Åß„Éñ„É¨„Éº„ÇØ„Éù„Ç§„É≥„ÉàË™øÊï¥ */
        th, td {
            padding: 45px 36px; /* „Çπ„Éû„Éõ„Åß„ÅØ„ÉÜ„Éº„Éñ„É´„Éë„Éá„Ç£„É≥„Ç∞„Çí3ÂÄç„Å´Êã°Â§ß */
            font-size: 3.6em; /* „Çπ„Éû„Éõ„Åß„ÅØ„ÉÜ„Éº„Éñ„É´ÊñáÂ≠ó„Çµ„Ç§„Ç∫„Çí3ÂÄç„Å´Êã°Â§ß */
        }
        
        /* „ÉÜ„Éº„Éñ„É´„ÅÆ„É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú„ÇíÂº∑Âåñ */
        table, thead, tbody, th, td, tr {
            display: block;
        }
        
        /* „Éò„ÉÉ„ÉÄ„Éº„ÇíÈùûË°®Á§∫ */
        thead tr {
            position: absolute;
            top: -9999px;
            left: -9999px;
        }
        
        tr {
            margin-bottom: 45px; /* 3ÂÄç„Å´Êã°Â§ß */
            border: 3px solid #ccc; /* 3ÂÄç„Å´Êã°Â§ß */
            border-radius: 24px; /* Ëßí‰∏∏„Çí3ÂÄç„Å´Êã°Â§ß */
            background-color: #fff;
        }
        
        td {
            /* td„Çí„Éñ„É≠„ÉÉ„ÇØË¶ÅÁ¥†„Å®„Åó„Å¶Ë°®Á§∫„Åó„ÄÅÂêÑ„Çª„É´„ÅÆÂâç„Å´„É©„Éô„É´„ÇíË°®Á§∫ */
            position: relative;
            padding-left: 50%;
            border: none;
            border-bottom: 3px solid #eee; /* 3ÂÄç„Å´Êã°Â§ß */
        }
        
        td:before {
            /* „É©„Éô„É´„Å®„Åó„Å¶‰ΩøÁî®„Åô„Çã„Ç≥„É≥„ÉÜ„É≥„ÉÑ */
            position: absolute;
            top: 45px; /* 3ÂÄç„Å´Êã°Â§ß */
            left: 45px; /* 3ÂÄç„Å´Êã°Â§ß */
            width: 45%;
            padding-right: 30px; /* 3ÂÄç„Å´Êã°Â§ß */
            white-space: nowrap;
            font-weight: bold;
        }
        
        /* ÂêÑ„Çª„É´„ÅÆ„É©„Éô„É´ */
        td:nth-of-type(1):before { content: "ÈÅ∏Êäû"; }
        td:nth-of-type(2):before { content: "Êõ∏Á±çID"; }
        td:nth-of-type(3):before { content: "Êõ∏Á±çÂêç"; }
        td:nth-of-type(4):before { content: "Ë≤∏Âá∫Êó•ÊôÇ"; }
        td:nth-of-type(5):before { content: "ËøîÂç¥‰∫àÂÆöÊó•"; }
      }
      
      @media (max-width: 600px) {
         .container {
             padding: 30px; /* „Çπ„Éû„Éõ„Åß„ÅØ„Ç≥„É≥„ÉÜ„ÉäÂÜÖ„Éë„Éá„Ç£„É≥„Ç∞„Çí3ÂÄç„Å´Êã°Â§ß */
         }
        h1 {
          font-size: 66px; /* 3ÂÄç„Å´Êã°Â§ß */
          padding-left: 15px; /* 3ÂÄç„Å´Êã°Â§ß */
          padding-right: 15px; /* 3ÂÄç„Å´Êã°Â§ß */
        }
        .form-group {
            padding-left: 15px; /* 3ÂÄç„Å´Êã°Â§ß */
            padding-right: 15px; /* 3ÂÄç„Å´Êã°Â§ß */
        }
        #rental-records {
             padding-left: 15px; /* 3ÂÄç„Å´Êã°Â§ß */
             padding-right: 15px; /* 3ÂÄç„Å´Êã°Â§ß */
        }
        #message {
            margin-left: 15px; /* 3ÂÄç„Å´Êã°Â§ß */
            margin-right: 15px; /* 3ÂÄç„Å´Êã°Â§ß */
            font-size: 45px; /* 3ÂÄç„Å´Êã°Â§ß */
        }
        button {
          width: 100%; /* Â∞èÁîªÈù¢„Åß„ÅØ„Éú„Çø„É≥ÂπÖ„Çí100%„Å´ */
          margin-right: 0;
          margin-bottom: 30px; /* „Éú„Çø„É≥Èñì„ÅÆÁ∏¶„Çπ„Éö„Éº„Çπ„Çí3ÂÄç„Å´Êã°Â§ß */
          padding: 45px; /* 3ÂÄç„Å´Êã°Â§ß */
          font-size: 48px; /* 3ÂÄç„Å´Êã°Â§ß */
          min-height: 150px; /* „Çø„ÉÉ„ÉÅ„Çø„Éº„Ç≤„ÉÉ„Éà„Çí3ÂÄç„Å´Êã°Â§ß */
        }
        #scan-user-id-button { 
             margin-bottom: 30px; /* „Çπ„Ç≠„É£„É≥„Éú„Çø„É≥‰∏ã„ÅÆ„Çπ„Éö„Éº„Çπ„Çí3ÂÄç„Å´Êã°Â§ß */
             padding: 45px; /* 3ÂÄç„Å´Êã°Â§ß */
        }
        button:last-of-type {
             margin-bottom: 0;
        }
        
        /* „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Çí„Åï„Çâ„Å´Â§ß„Åç„Åè */
        .book-checkbox {
            width: 90px; /* 3ÂÄç„Å´Êã°Â§ß */
            height: 90px; /* 3ÂÄç„Å´Êã°Â§ß */
        }
      }
      
      /* iPhone„Åä„Çà„Å≥AndroidÂêë„Åë„ÅÆËøΩÂä†Ë™øÊï¥ */
      @media (max-width: 480px) {
        body, html {
          font-size: 45px; /* 3ÂÄç„Å´Êã°Â§ß */
        }
        input[type="text"], input[type="number"] {
          font-size: 48px; /* 3ÂÄç„Å´Êã°Â§ß */
          padding: 36px; /* 3ÂÄç„Å´Êã°Â§ß */
        }
        .no-records {
          font-size: 45px; /* 3ÂÄç„Å´Êã°Â§ß */
          padding: 60px; /* 3ÂÄç„Å´Êã°Â§ß */
        }
      }
      /* --- Menu Button --- */
      .menu-button {
        background: linear-gradient(135deg, #8b6f4e 0%, #6d5640 100%);
        color: white;
        padding: 30px 60px;
        font-size: 48px;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 15px;
        margin: 30px 0;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        font-weight: 700;
      }
      .menu-button:hover {
        background: linear-gradient(135deg, #6d5640 0%, #5a4635 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
      }
      .menu-button-container {
        text-align: center;
        margin: 30px 0;
        position: relative;
        z-index: 2;
      }
    </style>
  </head>
  <body>
    <div class="menu-button-container"><a href="#" class="menu-button" id="menu-button-top">‚Üê „É°„Éã„É•„Éº„Å´Êàª„Çã</a></div>
    <div class="container">
      <h1>Âà©Áî®ËÄÖÂà•ËøîÂç¥</h1>

      <div class="form-group">
        <label for="user-id">Âà©Áî®ËÄÖID</label>
        <button id="scan-user-id-button">Âà©Áî®ËÄÖID„Çí„Çπ„Ç≠„É£„É≥</button>
        <input type="text" id="user-id" name="userId" placeholder="„Çπ„Ç≠„É£„É≥„Åô„Çã„ÅãÊâãÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ">
        <div id="scanner-container-user-returns" class="scanner-container" style="display: none;">
          <div class="scanner-header">
            <button class="camera-switch-btn" onclick="switchCamera('interactive')">üì∑ ÂàáÊõø</button>
            <button class="close-scanner-btn" onclick="closeScanner('interactive')">‚úï Èñâ„Åò„Çã</button>
          </div>
          <div id="interactive" class="scanner-viewport"></div>
        </div>
      </div>

      <button onclick="searchUserRentals()">Ê§úÁ¥¢</button>
      <p id="message"></p>

      <div id="rental-records" style="display: none;">
        <h2>Êú™ËøîÂç¥‰∏ÄË¶ß</h2>
        <div id="records-container"></div>
      </div>
    </div>

    <!-- „Éê„Éº„Ç≥„Éº„ÉâË™≠„ÅøÂèñ„Çä„É©„Ç§„Éñ„É©„É™ (QuaggaJS„Çí‰ΩøÁî®) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script>
      let isScanning = false;
      let currentUserName = '';
      let currentFacingMode = "environment"; // „Ç´„É°„É©„ÅÆÂêë„ÅçÔºàenvironment: „Ç¢„Ç¶„Éà„Ç´„É°„É©„ÄÅuser: „Ç§„É≥„Ç´„É°„É©Ôºâ
      // Web Audio API„Çí‰ΩøÁî®„Åó„Åü„Éì„Éº„ÉóÈü≥ÁîüÊàêÈñ¢Êï∞
      function playBeepSound() {
        try {
          // Web Audio API„Çí‰ΩøÁî®„Åó„Å¶„Éì„Éº„ÉóÈü≥„ÇíÁîüÊàê
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          oscillator.frequency.value = 800; // 800Hz„ÅÆ„Éì„Éº„ÉóÈü≥
          oscillator.type = 'sine';
          
          gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
          
          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.1);
        } catch (e) {
          console.log('„Éì„Éº„ÉóÈü≥„ÅÆÂÜçÁîü„Çí„Çπ„Ç≠„ÉÉ„Éó:', e);
        }
      }

      // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÂÆå‰∫ÜÊôÇ„ÅÆÂá¶ÁêÜ
      window.onload = function() {
        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
      };

      // „Çπ„Ç≠„É£„É≥„Éú„Çø„É≥„ÅÆÂá¶ÁêÜ
      document.getElementById('scan-user-id-button').addEventListener('click', () => {
        toggleScanner('interactive', 'user-id');
      });

      // „Çπ„Ç≠„É£„Éä„Éº„ÅÆË°®Á§∫/ÈùûË°®Á§∫„ÇíÂàá„ÇäÊõø„Åà„ÇãÈñ¢Êï∞
      function toggleScanner(viewportId, inputFieldId) {
        const containerId = 'scanner-container-user-returns';
        const container = document.getElementById(containerId);
        
        if (container.style.display === 'none') {
          container.style.display = 'flex';
          startScanner(viewportId, inputFieldId);
        } else {
          closeScanner(viewportId);
        }
      }

      function closeScanner(viewportId) {
        const containerId = 'scanner-container-user-returns';
        const container = document.getElementById(containerId);
        container.style.display = 'none';
        stopScanner(viewportId);
      }

      function startScanner(targetElementId, inputFieldId) {
        setMessage("„Ç´„É°„É©„ÇíËµ∑Âãï„Åó„Å¶„ÅÑ„Åæ„Åô...");
        
        // Êó¢Â≠ò„ÅÆQuagga„Ç§„É≥„Çπ„Çø„É≥„Çπ„ÇíÂÅúÊ≠¢
        if (typeof Quagga !== 'undefined' && Quagga._handler) {
          Quagga.stop();
        }
        
        // „Éì„É•„Éº„Éù„Éº„Éà„ÇíÂÆåÂÖ®„Å´„ÇØ„É™„Ç¢
        const viewport = document.getElementById(targetElementId);
        if (viewport) {
          viewport.innerHTML = '';
        }

        // Quagga„ÅåÁîüÊàê„Åó„ÅüÂèØËÉΩÊÄß„ÅÆ„ÅÇ„ÇãË¶ÅÁ¥†„Çí„Ç∞„É≠„Éº„Éê„É´„Å´ÂâäÈô§
        document.querySelectorAll('.drawingBuffer').forEach(el => el.remove());
        
        isScanning = true;
        
        // ÂàùÊúüÂåñ„ÇíÈÅÖÂª∂ÂÆüË°å
        setTimeout(() => {
          initializeScanner(targetElementId, inputFieldId);
        }, 300); // „Çπ„Éû„Éõ„Åß„ÅØÂ∞ë„ÅóÈï∑„ÇÅ„Å´ÂæÖÊ©ü
      }
      
      function initializeScanner(targetElementId, inputFieldId) {
        // „Éá„Éê„Ç§„ÇπÂà§ÂÆö
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        
        Quagga.init({
          inputStream : {
            name : "Live",
            type : "LiveStream",
            target: document.querySelector(`#${targetElementId}`),
            constraints: {
              width: { min: 640, ideal: isMobile ? 1280 : 1920, max: 1920 },
              height: { min: 480, ideal: isMobile ? 720 : 1080, max: 1080 },
              facingMode: currentFacingMode,
              aspectRatio: isMobile ? { ideal: 16/9 } : undefined
            },
            area: isMobile ? { top: "0%", right: "0%", left: "0%", bottom: "0%" } : undefined
          },
          locator: {
            patchSize: isMobile ? "large" : "medium",
            halfSample: !isMobile
          },
          numOfWorkers: isMobile ? 2 : 4,
          frequency: isMobile ? 5 : 10,
          decoder : { 
            readers : [          // Ë§áÊï∞„ÅÆ„Éê„Éº„Ç≥„Éº„Éâ„É™„Éº„ÉÄ„Éº„ÇíÊúâÂäπÂåñ
              'code_128_reader',
              'code_39_reader',
              'ean_reader',
              'ean_8_reader',
              'code_93_reader'
            ],
            debug: {
              drawBoundingBox: true,
              showFrequency: true,
              drawScanline: true,
              showPattern: true
            },
            multiple: false,     // Ë§áÊï∞„ÅÆ„Éê„Éº„Ç≥„Éº„Éâ„ÇíÂêåÊôÇ„Å´Ë™≠„ÅøÂèñ„Çâ„Å™„ÅÑ
            tryHarder: true      // „Çà„ÇäÁ©çÊ•µÁöÑ„Å´„Çπ„Ç≠„É£„É≥„ÇíË©¶„Åø„Çã
          },
          locate: true
        }, function(err) {
            if (err) {
                console.error(err);
                setMessage(`„Çπ„Ç≠„É£„Éä„Éº„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó: ${err.name}. „Ç´„É°„É©„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
                document.getElementById(targetElementId).style.display = 'none';
                isScanning = false;
                return;
            }
            console.log("„Çπ„Ç≠„É£„Éä„ÉºÂàùÊúüÂåñÂÆå‰∫Ü");
            setMessage("„Éê„Éº„Ç≥„Éº„Éâ„Çí„Ç´„É°„É©„Å´Âêë„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
            Quagga.start();
        });

        // onProcessed„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ„ÇíÂâäÈô§„Åó„Å¶„Ç™„Éº„Éê„Éº„É¨„Ç§„ÇíÈùûË°®Á§∫

        // ÈáçË§áÈò≤Ê≠¢„ÅÆ„Åü„ÇÅ„ÅÆ„Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Å®ÂâçÂõû„ÅÆ„Ç≥„Éº„Éâ
        let lastDetectedTime = 0;
        let lastDetectedCode = null;
        const COOLDOWN_PERIOD = 3000; // Âêå„Åò„Ç≥„Éº„Éâ„ÇíÂÜçÊ§úÂá∫„Åô„Çã„Åæ„Åß„ÅÆÂæÖÊ©üÊôÇÈñìÔºà„Éü„É™ÁßíÔºâ
        
        Quagga.onDetected(function(result) {
          // „Çπ„Ç≠„É£„Éä„Éº„ÅåÂÅúÊ≠¢„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÂá¶ÁêÜ„Åó„Å™„ÅÑ
          if (!isScanning) {
            console.log("„Çπ„Ç≠„É£„Éä„Éº„ÅØÊó¢„Å´ÂÅúÊ≠¢„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Ç§„Éô„É≥„Éà„ÇíÁÑ°Ë¶ñ„Åó„Åæ„Åô„ÄÇ");
            return;
          }
          
          const code = result.codeResult.code;
          const currentTime = new Date().getTime();
          console.log("„Éê„Éº„Ç≥„Éº„ÉâÊ§úÂá∫:", code, "‰ø°È†ºÂ∫¶:", result.codeResult.confidence);
          
          // ‰ø°È†ºÂ∫¶„Åå‰Ωé„ÅÑÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„ÉóÔºàÈñæÂÄ§„Çí‰∏ã„Åí„Å¶Ê§úÂá∫ÁéáÂêë‰∏äÔºâ
          if (result.codeResult.confidence < 0.5) {
            console.log("‰ø°È†ºÂ∫¶„Åå‰Ωé„ÅÑ„Åü„ÇÅÁÑ°Ë¶ñ„Åó„Åæ„Åô:", result.codeResult.confidence);
            return;
          }
          
          // ÂâçÂõû„Å®Âêå„Åò„Ç≥„Éº„Éâ„Åß„ÄÅ„ÇØ„Éº„É´„ÉÄ„Ç¶„É≥ÊúüÈñìÂÜÖ„ÅÆÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
          if (code === lastDetectedCode && (currentTime - lastDetectedTime) < COOLDOWN_PERIOD) {
            console.log(`Âêå„Åò„Ç≥„Éº„Éâ„ÅåÁü≠ÊôÇÈñì„ÅßÊ§úÂá∫„Åï„Çå„Åæ„Åó„Åü„ÄÇÁÑ°Ë¶ñ„Åó„Åæ„Åô„ÄÇÁµåÈÅéÊôÇÈñì: ${currentTime - lastDetectedTime}ms`);
            return;
          }
          
          // Êñ∞„Åó„ÅÑ„Ç≥„Éº„Éâ„Å®„Åó„Å¶Âá¶ÁêÜ
          lastDetectedCode = code;
          lastDetectedTime = currentTime;
          
          document.getElementById(inputFieldId).value = code;
          setMessage(`„Ç≥„Éº„Éâ„Äå${code}„Äç„ÇíË™≠„ÅøÂèñ„Çä„Åæ„Åó„Åü„ÄÇ`);
          
          // „Éì„Éº„ÉóÈü≥„ÇíÂÜçÁîü
          playBeepSound();
          
          closeScanner(targetElementId);
          searchUserRentals(); // Âà©Áî®ËÄÖID„ÅåË™≠„ÅøÂèñ„Çå„Åü„ÇâËá™ÂãïÁöÑ„Å´Ê§úÁ¥¢
        });
      }

      function stopScanner(viewportId) {
        // Quagga„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        if (typeof Quagga !== 'undefined' && Quagga._handler && Quagga._handler.inputStream) {
          try {
            // „Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„Éº„Çí„ÇØ„É™„Ç¢
            Quagga.offProcessed();
            Quagga.offDetected();
            Quagga.stop();
          } catch (e) {
            console.log('Quagga.stop() „Ç®„É©„ÉºÔºàÁÑ°Ë¶ñÂèØËÉΩÔºâ:', e);
          }
        }
        
        // „Éì„É•„Éº„Éù„Éº„Éà„ÇíÂÆåÂÖ®„Å´„ÇØ„É™„Ç¢
        const viewport = document.getElementById(viewportId);
        if (viewport) {
          // „Åô„Åπ„Å¶„ÅÆÂ≠êË¶ÅÁ¥†„ÇíÂº∑Âà∂ÁöÑ„Å´ÂâäÈô§
          while (viewport.firstChild) {
            viewport.removeChild(viewport.firstChild);
          }
          
          // „Ç§„É≥„É©„Ç§„É≥„Çπ„Çø„Ç§„É´„ÇíÂÆåÂÖ®„Å´„É™„Çª„ÉÉ„Éà
          viewport.removeAttribute('style');
          
          // Quagga„ÅåÁîüÊàê„Åó„ÅüÂèØËÉΩÊÄß„ÅÆ„ÅÇ„ÇãË¶ÅÁ¥†„Çí„Ç∞„É≠„Éº„Éê„É´„Å´Ê§úÁ¥¢„Åó„Å¶ÂâäÈô§
          document.querySelectorAll('.drawingBuffer').forEach(el => el.remove());
        }
        
        // „Çπ„Ç≠„É£„Éä„Éº„Ç≥„É≥„ÉÜ„ÉäÂÜÖ„ÅÆ„Åô„Åπ„Å¶„ÅÆcanvasË¶ÅÁ¥†„ÇíÂâäÈô§
        const container = document.getElementById('scanner-container-user-returns');
        if (container) {
          container.querySelectorAll('canvas').forEach(el => el.remove());
          container.querySelectorAll('video').forEach(el => el.remove());
        }
        
        // „Çπ„Ç≠„É£„É≥Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
        isScanning = false;
      }

      // Âà©Áî®ËÄÖ„ÅÆÊú™ËøîÂç¥‰∏ÄË¶ß„ÇíÊ§úÁ¥¢„Åô„ÇãÈñ¢Êï∞
      function searchUserRentals() {
        const userId = document.getElementById('user-id').value.trim();
        if (!userId) {
          setMessage("Âà©Áî®ËÄÖID„ÇíÂÖ•Âäõ„Åæ„Åü„ÅØ„Çπ„Ç≠„É£„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
          return;
        }

        setMessage("Âà©Áî®ËÄÖÊÉÖÂ†±„Å®Êú™ËøîÂç¥‰∏ÄË¶ß„ÇíÊ§úÁ¥¢‰∏≠...");
        document.getElementById('rental-records').style.display = 'none';
        document.getElementById('records-container').innerHTML = '';
        
        // „Åæ„ÅöÂà©Áî®ËÄÖÊÉÖÂ†±„ÇíÂèñÂæó
        google.script.run
          .withSuccessHandler((userInfo) => {
            if (userInfo && userInfo.name) {
              currentUserName = userInfo.name;
              // Âà©Áî®ËÄÖÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Å£„Åü„Çâ„ÄÅÊú™ËøîÂç¥‰∏ÄË¶ß„ÇíÊ§úÁ¥¢
              fetchUnreturnedBooks(userId);
            } else {
              setMessage("Âà©Áî®ËÄÖÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇÂà©Áî®ËÄÖID„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
            }
          })
          .withFailureHandler((error) => {
            setMessage(`Âà©Áî®ËÄÖÊÉÖÂ†±„ÅÆÂèñÂæó„Ç®„É©„Éº: ${error.message}`);
            console.error("Âà©Áî®ËÄÖÊÉÖÂ†±ÂèñÂæó„Ç®„É©„Éº:", error);
          })
          .getUserInfo(userId);
      }

      // Êú™ËøîÂç¥‰∏ÄË¶ß„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞
      function fetchUnreturnedBooks(userId) {
        // „Çµ„Éº„Éê„Éº„Çµ„Ç§„Éâ„ÅßÊú™ËøîÂç¥‰∏ÄË¶ß„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åô
        google.script.run
          .withSuccessHandler((result) => {
            console.log("Ê§úÁ¥¢ÁµêÊûú:", result);
            
            if (result && result.records && result.records.length > 0) {
              // Êú™ËøîÂç¥„ÅÆÊú¨„Å†„Åë„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
              const unreturnedBooks = result.records.filter(record => record.status === "Êú™ËøîÂç¥");
              
              if (unreturnedBooks.length > 0) {
                displayRentalRecords(unreturnedBooks);
                setMessage(`${currentUserName} „Åï„Çì„ÅÆÊú™ËøîÂç¥Êú¨„Åå ${unreturnedBooks.length} ‰ª∂Ë¶ã„Å§„Åã„Çä„Åæ„Åó„Åü„ÄÇ`);
              } else {
                // ËøîÂç¥Âá¶ÁêÜÂæå„ÅÆÂÜçÊ§úÁ¥¢„Åã„Å©„ÅÜ„Åã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                const previousMessage = document.getElementById('message').innerText;
                if (previousMessage.includes("ËøîÂç¥Âá¶ÁêÜ‰∏≠") || previousMessage.includes("ÊÆã„Çä„ÅÆË≤∏Âá∫Êú¨„ÇíÊ§úÁ¥¢‰∏≠")) {
                  setMessage(`‚úÖ „Åô„Åπ„Å¶ËøîÂç¥ÂÆå‰∫ÜÔºÅ ${currentUserName} „Åï„Çì„ÅÆÊú™ËøîÂç¥Êú¨„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ`);
                  document.getElementById('rental-records').style.display = 'block';
                  document.getElementById('records-container').innerHTML = `
                    <div style="text-align: center; padding: 60px; background: linear-gradient(135deg, #d4edda 0%, #c8e6cc 100%); border-radius: 20px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">
                      <p style="font-size: 96px; margin: 0;">üéâ</p>
                      <p class="no-records" style="color: #155724; font-weight: bold; font-size: 54px; margin: 30px 0;">
                        ${currentUserName} „Åï„Çì<br>
                        „Åô„Åπ„Å¶„ÅÆÊú¨„ÅåËøîÂç¥„Åï„Çå„Åæ„Åó„ÅüÔºÅ
                      </p>
                      <p style="color: #155724; font-size: 42px;">„ÅîÂà©Áî®„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åó„Åü</p>
                    </div>
                  `;
                } else {
                  setMessage(`${currentUserName} „Åï„Çì„ÅÆÊú™ËøîÂç¥Êú¨„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ`);
                  document.getElementById('rental-records').style.display = 'block';
                  document.getElementById('records-container').innerHTML = '<p class="no-records">Êú™ËøîÂç¥„ÅÆÊú¨„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>';
                }
              }
            } else {
              setMessage(`${currentUserName} „Åï„Çì„ÅÆË≤∏Âá∫Ë®òÈå≤„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ`);
              document.getElementById('rental-records').style.display = 'block';
              document.getElementById('records-container').innerHTML = '<p class="no-records">Ë©≤ÂΩì„Åô„ÇãË≤∏Âá∫Ë®òÈå≤„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>';
            }
          })
          .withFailureHandler((error) => {
            setMessage(`Ë≤∏Âá∫Ë®òÈå≤„ÅÆÊ§úÁ¥¢„Ç®„É©„Éº: ${error.message}`);
            console.error("Ë≤∏Âá∫Ë®òÈå≤Ê§úÁ¥¢„Ç®„É©„Éº:", error);
            document.getElementById('rental-records').style.display = 'block';
            document.getElementById('records-container').innerHTML = '<p class="no-records">Ê§úÁ¥¢‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ</p>';
          })
          .getUserRentals(userId);
      }

      // ÈÅ∏Êäû„Åï„Çå„ÅüÊõ∏Á±çID„Çí‰øùÊåÅ„Åô„ÇãÈÖçÂàó
      let selectedBookIds = [];
      
      // Ë≤∏Âá∫Ë®òÈå≤„ÇíË°®Á§∫„Åô„ÇãÈñ¢Êï∞
      function displayRentalRecords(records) {
        console.log("Ë°®Á§∫„Åô„ÇãË≤∏Âá∫Ë®òÈå≤:", records);
        
        const container = document.getElementById('records-container');
        selectedBookIds = []; // ÈÅ∏Êäû„É™„Çπ„Éà„Çí„É™„Çª„ÉÉ„Éà
        
        // „ÉÜ„Éº„Éñ„É´„Çí‰ΩúÊàê
        let html = `
          <table>
            <thead>
              <tr>
                <th><input type="checkbox" id="select-all-checkbox" onclick="toggleAllCheckboxes()"></th>
                <th>Êõ∏Á±çID</th>
                <th>Êõ∏Á±çÂêç</th>
                <th>Ë≤∏Âá∫Êó•ÊôÇ</th>
                <th>ËøîÂç¥‰∫àÂÆöÊó•</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        // „É¨„Ç≥„Éº„Éâ„Åî„Å®„Å´Ë°å„ÇíËøΩÂä†
        records.forEach(record => {
          console.log("„É¨„Ç≥„Éº„ÉâË©≥Á¥∞:", record);
          
          // Êó•‰ªòÊñáÂ≠óÂàó„Çí„Éï„Ç©„Éº„Éû„ÉÉ„Éà (ISOÊñáÂ≠óÂàó„Åã„ÇâDate„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíÁîüÊàê)
          let lendingDateStr = 'N/A';
          if (record.lendingDate && typeof record.lendingDate === 'string') {
            try {
              lendingDateStr = new Date(record.lendingDate).toLocaleString();
            } catch (e) { console.error("Ë≤∏Âá∫Êó•ÊôÇ„ÅÆ„Éë„Éº„Çπ„Ç®„É©„Éº:", e); }
          }
          
          let dueDateStr = 'N/A';
          if (record.dueDate && typeof record.dueDate === 'string') {
            try {
              dueDateStr = new Date(record.dueDate).toLocaleDateString(); // Êó•‰ªò„ÅÆ„ÅøË°®Á§∫
            } catch (e) { console.error("ËøîÂç¥‰∫àÂÆöÊó•„ÅÆ„Éë„Éº„Çπ„Ç®„É©„Éº:", e); }
          }
          
          html += `
            <tr>
              <td><input type="checkbox" class="book-checkbox" data-book-id="${record.bookId}" data-user-id="${record.userId}" data-lending-date="${record.lendingDate}" data-row-number="${record.rowNumber}" onchange="updateSelectedBooks()"></td>
              <td>${record.bookId || 'N/A'}</td>
              <td>${record.bookTitle || 'N/A'}</td>
              <td>${lendingDateStr}</td>
              <td>${dueDateStr}</td>
            </tr>
          `;
        });
        
        html += `
            </tbody>
          </table>
          <button id="bulk-return-button" onclick="returnSelectedBooks()" disabled>ÈÅ∏Êäû„Åó„ÅüÊú¨„Çí„Åæ„Å®„ÇÅ„Å¶ËøîÂç¥</button>
        `;
        
        container.innerHTML = html;
        document.getElementById('rental-records').style.display = 'block';
        updateBulkReturnButtonState(); // „Éú„Çø„É≥„ÅÆÂàùÊúüÁä∂ÊÖã„ÇíË®≠ÂÆö
      }
      
      // ÂÖ®„Å¶„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÈÅ∏Êäû/Ëß£Èô§„ÇíÂàá„ÇäÊõø„Åà„ÇãÈñ¢Êï∞
      function toggleAllCheckboxes() {
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const checkboxes = document.querySelectorAll('.book-checkbox');
        
        checkboxes.forEach(checkbox => {
          checkbox.checked = selectAllCheckbox.checked;
        });
        
        updateSelectedBooks();
      }
      
      // ÈÅ∏Êäû„Åï„Çå„ÅüÊõ∏Á±çID„ÅÆ„É™„Çπ„Éà„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
      function updateSelectedBooks() {
        selectedBookIds = [];
        const checkboxes = document.querySelectorAll('.book-checkbox:checked');
        
        checkboxes.forEach(checkbox => {
          const rowNumber = checkbox.getAttribute('data-row-number');
          const bookId = checkbox.getAttribute('data-book-id');
          if (rowNumber) {
            selectedBookIds.push({
              rowNumber: parseInt(rowNumber),
              bookId: bookId // „Éá„Éê„ÉÉ„Ç∞Áî®„Å´‰øùÊåÅ
            });
          }
        });
        
        console.log("ÈÅ∏Êäû„Åï„Çå„ÅüÊõ∏Á±çID:", selectedBookIds);
        updateBulkReturnButtonState();
      }
      
      // „Åæ„Å®„ÇÅ„Å¶ËøîÂç¥„Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
      function updateBulkReturnButtonState() {
        const bulkReturnButton = document.getElementById('bulk-return-button');
        if (bulkReturnButton) {
          bulkReturnButton.disabled = selectedBookIds.length === 0;
        }
      }
      
      // ÈÅ∏Êäû„Åï„Çå„ÅüÊú¨„Çí„Åæ„Å®„ÇÅ„Å¶ËøîÂç¥„Åô„ÇãÈñ¢Êï∞
      function returnSelectedBooks() {
        if (selectedBookIds.length === 0) {
          setMessage("ËøîÂç¥„Åô„ÇãÊú¨„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ");
          return;
        }

        setMessage(`ÈÅ∏Êäû„Åï„Çå„Åü ${selectedBookIds.length} ÂÜä„ÅÆÊú¨„ÇíËøîÂç¥Âá¶ÁêÜ‰∏≠...`);
        
        google.script.run
          .withSuccessHandler((result) => {
            console.log("‰∏ÄÊã¨ËøîÂç¥ÁµêÊûú:", result);
            
            if (result && result.message) {
              // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫Ôºà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂäπÊûú‰ªò„ÅçÔºâ
              const messageEl = document.getElementById('message');
              messageEl.innerHTML = `<span style="animation: fadeInScale 0.5s ease-out;">‚úÖ ${result.message}</span>`;
              
              // CSS„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíËøΩÂä†
              if (!document.getElementById('success-animation-style')) {
                const style = document.createElement('style');
                style.id = 'success-animation-style';
                style.textContent = `
                  @keyframes fadeInScale {
                    0% { opacity: 0; transform: scale(0.8); }
                    50% { transform: scale(1.1); }
                    100% { opacity: 1; transform: scale(1); }
                  }
                `;
                document.head.appendChild(style);
              }
              
              // ËøîÂç¥Âá¶ÁêÜÂæå„ÄÅÊú™ËøîÂç¥‰∏ÄË¶ß„ÇíÂÜçÂèñÂæó
              const userId = document.getElementById('user-id').value.trim();
              
              // ÂÖ•Âäõ„Éï„Ç©„Éº„É†„ÇíÂàùÊúüÂåñ„Åó„Å¶Ê¨°„ÅÆÂÖ•Âäõ„Å´ÂÇô„Åà„Çã
              selectedBookIds = []; // ÈÅ∏Êäû„É™„Çπ„Éà„Çí„É™„Çª„ÉÉ„Éà
              
              // 1ÁßíÂæå„Å´ÂÜçÊ§úÁ¥¢
              setTimeout(() => {
                setMessage("ÊÆã„Çä„ÅÆË≤∏Âá∫Êú¨„ÇíÊ§úÁ¥¢‰∏≠...");
                fetchUnreturnedBooks(userId);
                
                // „Éï„Ç©„Éº„Ç´„Çπ„ÇíÂà©Áî®ËÄÖIDÂÖ•ÂäõÊ¨Ñ„Å´ÁßªÂãï
                setTimeout(() => {
                  document.getElementById('user-id').focus();
                }, 500);
              }, 1000);
            } else {
              setMessage("ËøîÂç¥Âá¶ÁêÜ„ÅÆÁµêÊûú„Åå‰∏çÊòé„Åß„Åô„ÄÇ");
            }
          })
          .withFailureHandler((error) => {
            setMessage(`‰∏ÄÊã¨ËøîÂç¥Âá¶ÁêÜ„Ç®„É©„Éº: ${error.message}`);
            console.error("‰∏ÄÊã¨ËøîÂç¥Âá¶ÁêÜ„Ç®„É©„Éº:", error);
          })
          .processBulkReturnByRowNumbers(selectedBookIds);
      }


      function setMessage(msg) {
        document.getElementById('message').innerText = msg;
      }
      
      // Âà©Áî®ËÄÖID„ÅåÊâãÂÖ•Âäõ„Åï„Çå„ÅüÂ†¥Âêà„Å´Enter„Ç≠„Éº„ÅßÊ§úÁ¥¢„ÇíÂÆüË°å
      document.getElementById('user-id').addEventListener('keypress', (event) => {
        if (event.key === 'Enter' && !isScanning) {
          searchUserRentals();
        }
      });
      
      // Ê§úÁ¥¢„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
      document.getElementById('search-user-button').addEventListener('click', () => {
        if (!isScanning) {
          const userId = document.getElementById('user-id').value.trim();
          if (userId) {
            searchUserRentals();
          } else {
            setMessage("Âà©Áî®ËÄÖID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
          }
        }
      });

      // „Ç´„É°„É©Âàá„ÇäÊõø„ÅàÈñ¢Êï∞
      function switchCamera(viewportId) {
        // „Ç´„É°„É©„ÅÆÂêë„Åç„ÇíÂàá„ÇäÊõø„Åà
        currentFacingMode = currentFacingMode === "environment" ? "user" : "environment";
        
        // ÁèæÂú®„ÅÆ„Çπ„Ç≠„É£„Éä„Éº„ÇíÂÅúÊ≠¢
        stopScanner(viewportId);
        
        // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„ÉâID„ÇíÂèñÂæó
        let inputFieldId = 'user-id';
        
        // Êñ∞„Åó„ÅÑ„Ç´„É°„É©Ë®≠ÂÆö„Åß„Çπ„Ç≠„É£„Éä„Éº„ÇíÂÜçËµ∑Âãï
        setTimeout(() => {
          startScanner(viewportId, inputFieldId);
        }, 300);
      }
    </script>
    <div class="menu-button-container"><a href="#" class="menu-button" id="menu-button-bottom">‚Üê „É°„Éã„É•„Éº„Å´Êàª„Çã</a></div>
    <script>
      // „É°„Éã„É•„Éº„Éú„Çø„É≥„ÅÆURL„ÇíË®≠ÂÆöÔºàÈ´òÈÄüÂåñÁâàÔºâ
      (function() {
        // URL„Çí„Ç≠„É£„ÉÉ„Ç∑„É•
        let cachedUrl = sessionStorage.getItem('webAppUrl');
        
        if (cachedUrl) {
          // „Ç≠„É£„ÉÉ„Ç∑„É•„Åå„ÅÇ„Çå„Å∞Âç≥Â∫ß„Å´Ë®≠ÂÆö
          document.getElementById('menu-button-top').href = cachedUrl;
          document.getElementById('menu-button-bottom').href = cachedUrl;
        } else {
          // „Ç≠„É£„ÉÉ„Ç∑„É•„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÂèñÂæó„Åó„Å¶„Ç≠„É£„ÉÉ„Ç∑„É•„Å´‰øùÂ≠ò
          google.script.run.withSuccessHandler(function(url) {
            sessionStorage.setItem('webAppUrl', url);
            document.getElementById('menu-button-top').href = url;
            document.getElementById('menu-button-bottom').href = url;
          }).getWebAppUrl();
        }
      })();
      
      // „Éñ„É©„Ç¶„Ç∂„ÅÆÊàª„Çã„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
      window.history.pushState(null, null, window.location.href);
      window.addEventListener('popstate', function(event) {
        window.history.pushState(null, null, window.location.href);
      });
    </script>
  </body>
</html>
